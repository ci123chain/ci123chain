package keeper

import (
	"encoding/hex"
	"fmt"
	sdk "github.com/ci123chain/ci123chain/pkg/abci/types"
	"github.com/ci123chain/ci123chain/pkg/vm/evmtypes"
	"github.com/umbracle/go-web3/abi"
	"math/big"
	"strings"
)

const DefaultERC20ABI = `[{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"},{"internalType":"uint8","name":"decimals_","type":"uint8"},{"internalType":"uint256","name":"initialSupply_","type":"uint256"},{"internalType":"bool","name":"canMint_","type":"bool"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"}]
`
const DefaultERC20ByteCode = "0x60806040523480156200001157600080fd5b5060405162001e2838038062001e2883398181016040528101906200003791906200037e565b84600390805190602001906200004f92919062000217565b5083600490805190602001906200006892919062000217565b5082600560006101000a81548160ff021916908360ff16021790555080600560016101000a81548160ff0219169083151502179055506000821115620000bb57620000ba3383620000c660201b60201c565b5b505050505062000750565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141562000139576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162000130906200046a565b60405180910390fd5b80600260008282546200014d919062000519565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254620001a4919062000519565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200020b91906200048c565b60405180910390a35050565b8280546200022590620005cf565b90600052602060002090601f01602090048101928262000249576000855562000295565b82601f106200026457805160ff191683800117855562000295565b8280016001018555821562000295579182015b828111156200029457825182559160200191906001019062000277565b5b509050620002a49190620002a8565b5090565b5b80821115620002c3576000816000905550600101620002a9565b5090565b6000620002de620002d884620004d2565b620004a9565b905082815260208101848484011115620002f757600080fd5b6200030484828562000599565b509392505050565b6000815190506200031d8162000702565b92915050565b600082601f8301126200033557600080fd5b815162000347848260208601620002c7565b91505092915050565b60008151905062000361816200071c565b92915050565b600081519050620003788162000736565b92915050565b600080600080600060a086880312156200039757600080fd5b600086015167ffffffffffffffff811115620003b257600080fd5b620003c08882890162000323565b955050602086015167ffffffffffffffff811115620003de57600080fd5b620003ec8882890162000323565b9450506040620003ff8882890162000367565b9350506060620004128882890162000350565b925050608062000425888289016200030c565b9150509295509295909350565b600062000441601f8362000508565b91506200044e82620006d9565b602082019050919050565b620004648162000582565b82525050565b60006020820190508181036000830152620004858162000432565b9050919050565b6000602082019050620004a3600083018462000459565b92915050565b6000620004b5620004c8565b9050620004c3828262000605565b919050565b6000604051905090565b600067ffffffffffffffff821115620004f057620004ef62000699565b5b620004fb82620006c8565b9050602081019050919050565b600082825260208201905092915050565b6000620005268262000582565b9150620005338362000582565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156200056b576200056a6200063b565b5b828201905092915050565b60008115159050919050565b6000819050919050565b600060ff82169050919050565b60005b83811015620005b95780820151818401526020810190506200059c565b83811115620005c9576000848401525b50505050565b60006002820490506001821680620005e857607f821691505b60208210811415620005ff57620005fe6200066a565b5b50919050565b6200061082620006c8565b810181811067ffffffffffffffff8211171562000632576200063162000699565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b6200070d8162000576565b81146200071957600080fd5b50565b620007278162000582565b81146200073357600080fd5b50565b62000741816200058c565b81146200074d57600080fd5b50565b6116c880620007606000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806340c10f191161007157806340c10f191461016857806370a082311461018457806395d89b41146101b45780639dc29fac146101d2578063a9059cbb146101ee578063dd62ed3e1461021e576100a9565b806306fdde03146100ae578063095ea7b3146100cc57806318160ddd146100fc57806323b872dd1461011a578063313ce5671461014a575b600080fd5b6100b661024e565b6040516100c3919061100d565b60405180910390f35b6100e660048036038101906100e19190610df2565b6102e0565b6040516100f39190610ff2565b60405180910390f35b6101046102f7565b604051610111919061116f565b60405180910390f35b610134600480360381019061012f9190610da3565b610301565b6040516101419190610ff2565b60405180910390f35b6101526103eb565b60405161015f919061118a565b60405180910390f35b610182600480360381019061017d9190610df2565b6103f4565b005b61019e60048036038101906101999190610d3e565b610451565b6040516101ab919061116f565b60405180910390f35b6101bc610499565b6040516101c9919061100d565b60405180910390f35b6101ec60048036038101906101e79190610df2565b61052b565b005b61020860048036038101906102039190610df2565b610539565b6040516102159190610ff2565b60405180910390f35b61023860048036038101906102339190610d67565b610550565b604051610245919061116f565b60405180910390f35b60606003805461025d906112d3565b80601f0160208091040260200160405190810160405280929190818152602001828054610289906112d3565b80156102d65780601f106102ab576101008083540402835291602001916102d6565b820191906000526020600020905b8154815290600101906020018083116102b957829003601f168201915b5050505050905090565b60006102ed3384846105d7565b6001905092915050565b6000600254905090565b600061030e8484846107a2565b6000600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050828110156103d2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103c9906110cf565b60405180910390fd5b6103df85338584036105d7565b60019150509392505050565b60006012905090565b600560019054906101000a900460ff16610443576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161043a9061106f565b60405180910390fd5b61044d8282610a0d565b5050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060600480546104a8906112d3565b80601f01602080910402602001604051908101604052809291908181526020018280546104d4906112d3565b80156105215780601f106104f657610100808354040283529160200191610521565b820191906000526020600020905b81548152906001019060200180831161050457829003601f168201915b5050505050905090565b6105358282610b55565b5050565b60006105463384846107a2565b6001905092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610647576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161063e9061112f565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614156106b7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106ae9061108f565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610795919061116f565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610812576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108099061110f565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610882576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108799061102f565b60405180910390fd5b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610908576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108ff906110af565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461099b91906111c1565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516109ff919061116f565b60405180910390a350505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610a7d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a749061114f565b60405180910390fd5b8060026000828254610a8f91906111c1565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610ae491906111c1565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610b49919061116f565b60405180910390a35050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610bc5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bbc906110ef565b60405180910390fd5b60008060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610c4b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c429061104f565b60405180910390fd5b8181036000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160026000828254610ca29190611217565b92505081905550600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610d07919061116f565b60405180910390a3505050565b600081359050610d2381611664565b92915050565b600081359050610d388161167b565b92915050565b600060208284031215610d5057600080fd5b6000610d5e84828501610d14565b91505092915050565b60008060408385031215610d7a57600080fd5b6000610d8885828601610d14565b9250506020610d9985828601610d14565b9150509250929050565b600080600060608486031215610db857600080fd5b6000610dc686828701610d14565b9350506020610dd786828701610d14565b9250506040610de886828701610d29565b9150509250925092565b60008060408385031215610e0557600080fd5b6000610e1385828601610d14565b9250506020610e2485828601610d29565b9150509250929050565b610e378161125d565b82525050565b6000610e48826111a5565b610e5281856111b0565b9350610e628185602086016112a0565b610e6b81611363565b840191505092915050565b6000610e836023836111b0565b9150610e8e82611374565b604082019050919050565b6000610ea66022836111b0565b9150610eb1826113c3565b604082019050919050565b6000610ec96027836111b0565b9150610ed482611412565b604082019050919050565b6000610eec6022836111b0565b9150610ef782611461565b604082019050919050565b6000610f0f6026836111b0565b9150610f1a826114b0565b604082019050919050565b6000610f326028836111b0565b9150610f3d826114ff565b604082019050919050565b6000610f556021836111b0565b9150610f608261154e565b604082019050919050565b6000610f786025836111b0565b9150610f838261159d565b604082019050919050565b6000610f9b6024836111b0565b9150610fa6826115ec565b604082019050919050565b6000610fbe601f836111b0565b9150610fc98261163b565b602082019050919050565b610fdd81611289565b82525050565b610fec81611293565b82525050565b60006020820190506110076000830184610e2e565b92915050565b600060208201905081810360008301526110278184610e3d565b905092915050565b6000602082019050818103600083015261104881610e76565b9050919050565b6000602082019050818103600083015261106881610e99565b9050919050565b6000602082019050818103600083015261108881610ebc565b9050919050565b600060208201905081810360008301526110a881610edf565b9050919050565b600060208201905081810360008301526110c881610f02565b9050919050565b600060208201905081810360008301526110e881610f25565b9050919050565b6000602082019050818103600083015261110881610f48565b9050919050565b6000602082019050818103600083015261112881610f6b565b9050919050565b6000602082019050818103600083015261114881610f8e565b9050919050565b6000602082019050818103600083015261116881610fb1565b9050919050565b60006020820190506111846000830184610fd4565b92915050565b600060208201905061119f6000830184610fe3565b92915050565b600081519050919050565b600082825260208201905092915050565b60006111cc82611289565b91506111d783611289565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561120c5761120b611305565b5b828201905092915050565b600061122282611289565b915061122d83611289565b9250828210156112405761123f611305565b5b828203905092915050565b600061125682611269565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b60005b838110156112be5780820151818401526020810190506112a3565b838111156112cd576000848401525b50505050565b600060028204905060018216806112eb57607f821691505b602082108114156112ff576112fe611334565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000601f19601f8301169050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a206275726e20616d6f756e7420657863656564732062616c616e60008201527f6365000000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207468697320636f6e74726163742063616e206e6f74206d696e60008201527f7420746f6b656e00000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206160008201527f6c6c6f77616e6365000000000000000000000000000000000000000000000000602082015250565b7f45524332303a206275726e2066726f6d20746865207a65726f2061646472657360008201527f7300000000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b61166d8161124b565b811461167857600080fd5b50565b61168481611289565b811461168f57600080fd5b5056fea2646970667358221220c4e92d0cb64399b5e334b08cfb22e846ad81183eab407720baed3c383b7da83b64736f6c63430008040033"

func (k AttestationHandler) BuildParams(sender sdk.AccAddress, to *sdk.AccAddress, payload []byte) evmtypes.MsgEvmTx {
	return evmtypes.MsgEvmTx{
		From: sender,
		Data: evmtypes.TxData{
			Payload: payload,
			Amount: big.NewInt(0),
			Recipient: &((*to).Address),
		},
	}
}


func (k AttestationHandler) DeployERC20Contract(ctx sdk.Context, sender sdk.AccAddress, params interface{}) (sdk.AccAddress, error) {
	abiIns, err := abi.NewABI(DefaultERC20ABI)
	if err != nil {
		return sdk.AccAddress{}, err
	}

	bin, err := hex.DecodeString(strings.TrimPrefix(DefaultERC20ByteCode, "0x"))
	if err != nil {
		return sdk.AccAddress{}, err
	}

	data, err := abi.Encode(params, abiIns.Constructor.Inputs)
	if err != nil {
		return sdk.AccAddress{}, err
	}

	data = append(bin, data...)

	msg := k.BuildParams(sender, nil, data)

	result, err := k.evmKeeper.EvmTxExec(ctx, &msg)

	addStr := result.VMResult().Log
	fmt.Println(result.VMResult())
	return sdk.HexToAddress(addStr), err
}

func (k AttestationHandler) Mint(ctx sdk.Context, contract, owner, to sdk.AccAddress, amount *big.Int) error {
	abiIns, err := abi.NewABI(DefaultERC20ABI)
	if err != nil {
		return err
	}

	m, ok := abiIns.Methods["mint"]
	if !ok {
		return fmt.Errorf("invalid method")
	}

	params := []interface{}{to, amount}

	data, err := abi.Encode(params, m.Inputs)
	data = append(m.ID(), data...)

	msg := k.BuildParams(owner, &contract, data)

	result, err := k.evmKeeper.EvmTxExec(ctx, &msg)
	fmt.Println(result.VMResult())
	return err
}
